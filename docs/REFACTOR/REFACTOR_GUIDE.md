# 参数重构完整指南

## 📋 背景

当前项目中存在参数ID冲突问题：不同供应商的相同模型使用了相同的参数名（如 `videoDuration`、`aspectRatio` 等），导致：
- 切换模型时参数混乱
- 预设功能无法正确区分参数
- 历史记录恢复时参数错误

## 🎯 解决方案

为每个模型的参数添加唯一前缀，例如：
- `videoDuration` → `falWan25VideoDuration` (Fal 的 Wan 2.5)
- `videoDuration` → `ppioWan25VideoDuration` (派欧云的 Wan 2.5)

## 📊 影响范围

- **重命名参数**: 25 个
- **涉及模型**: 18 个
- **修改文件**: ~30 个

---

## 🔧 执行步骤

### 步骤 1: 备份项目 ⚠️

```bash
# 确保所有更改已提交
git status

# 创建备份分支
git checkout -b backup-before-refactor

# 提交当前状态
git add .
git commit -m "backup: before parameter refactor"

# 切回主分支
git checkout main

# 创建重构分支
git checkout -b refactor/parameter-conflicts
```

### 步骤 2: 预览重构 (DRY RUN)

```bash
# 运行基础脚本（预览模式）
python refactor_parameters.py

# 查看生成的报告
# 文件: refactor_report.md
```

**检查报告内容**：
- 确认参数重命名是否合理
- 检查涉及的文件列表
- 确认没有遗漏重要文件

### 步骤 3: 执行基础重构

```bash
# 执行基础重构（会修改文件）
python refactor_parameters.py --execute
```

**这一步会修改**：
- ✅ 模型定义文件
- ✅ 状态管理文件
- ✅ 预设映射文件
- ✅ 生成数据迁移脚本

### 步骤 4: 预览完整重构

```bash
# 运行完整脚本（预览模式）
python refactor_parameters_complete.py

# 查看生成的总结
# 文件: refactor_complete_summary.md
```

### 步骤 5: 执行完整重构

```bash
# 执行完整重构（会修改更多文件）
python refactor_parameters_complete.py --execute
```

**这一步会修改**：
- ✅ 适配器文件
- ✅ 选项构建器
- ✅ 组件文件
- ✅ 价格计算文件

### 步骤 6: 集成数据迁移

编辑 `src/App.tsx`，在文件开头添加：

```typescript
import { migrateAllData } from './utils/parameterMigration'

// 在组件初始化时调用
useEffect(() => {
  migrateAllData()
}, [])
```

### 步骤 7: 测试应用

```bash
# 启动开发服务器
npm run dev
```

**测试清单**：

#### A. 基础功能测试
- [ ] 应用能否正常启动（无编译错误）
- [ ] 能否正常切换模型
- [ ] 能否正常修改参数
- [ ] 参数面板显示是否正常

#### B. 模型特定测试
对每个受影响的模型进行测试：

**派欧云模型**：
- [ ] Wan 2.5 Preview - 时长参数
- [ ] Seedance V1 - 时长参数
- [ ] Kling 2.5 Turbo - 时长和比例参数
- [ ] Hailuo 2.3 - 时长和分辨率参数
- [ ] Pixverse V4.5 - 比例和分辨率参数

**Fal 模型**：
- [ ] Wan 2.5 Preview - 时长参数
- [ ] Seedance V1 - 时长参数
- [ ] Veo 3.1 - 时长参数
- [ ] Sora 2 - 时长参数
- [ ] LTX-2 - 时长参数
- [ ] Vidu Q2 - 时长参数
- [ ] Pixverse V5.5 - 时长参数
- [ ] Kling V2.6 Pro - 时长参数
- [ ] Nano Banana - 比例和数量参数
- [ ] Nano Banana Pro - 比例和数量参数
- [ ] Kling Image O1 - 比例和数量参数
- [ ] Z-Image-Turbo - 尺寸和数量参数
- [ ] Seedream 4.0 - 数量参数

#### C. 功能测试
- [ ] **预设功能**
  - 保存预设
  - 加载预设
  - 预设参数是否正确恢复

- [ ] **历史记录**
  - 从历史记录重新编辑
  - 参数是否正确恢复
  - 图片是否正确恢复

- [ ] **价格估算**
  - 切换不同模型
  - 修改参数
  - 价格是否正确计算

- [ ] **模型切换**
  - 从派欧云模型切换到 Fal 模型
  - 参数是否正确重置
  - 不应该出现参数混乱

#### D. 数据迁移测试
- [ ] 打开浏览器控制台
- [ ] 查看是否有迁移日志
- [ ] 检查 localStorage 中的数据是否已更新
- [ ] 旧的历史记录是否能正确加载

### 步骤 8: 手动检查

脚本无法完美处理所有情况，需要手动检查：

#### A. 搜索旧参数名
```bash
# 搜索是否还有遗漏的旧参数名
grep -r "videoDuration" src --include="*.ts" --include="*.tsx"
grep -r "aspectRatio" src --include="*.ts" --include="*.tsx"
grep -r "numImages" src --include="*.ts" --include="*.tsx"
```

对于每个搜索结果，判断：
- 是否是模型特有参数（如 `viduMode`）？→ 不需要修改
- 是否是通用参数但在特定模型上下文中？→ 需要修改

#### B. 检查类型定义
```bash
# 检查类型定义文件
ls src/types/
```

查看是否有参数类型定义需要更新。

#### C. 检查条件判断
搜索包含模型ID判断的代码：
```typescript
if (selectedModel === 'fal-ai-wan-25-preview') {
  // 确保这里使用了新的参数名
}
```

### 步骤 9: 修复问题

如果发现问题：

1. **编译错误**
   - 查看错误信息
   - 找到对应文件
   - 手动修正参数名

2. **运行时错误**
   - 打开浏览器控制台
   - 查看错误堆栈
   - 定位问题代码

3. **参数混乱**
   - 检查状态管理
   - 检查参数映射
   - 检查模型定义

### 步骤 10: 提交代码

```bash
# 查看所有修改
git status
git diff

# 添加所有修改
git add .

# 提交
git commit -m "refactor: resolve parameter conflicts across all models

- Renamed 25 conflicting parameters across 18 models
- Added unique prefixes for each model (ppio*, fal*, ms*)
- Updated adapters, components, builders, and pricing
- Added data migration for localStorage
- Generated by automated refactor scripts

Breaking changes:
- All conflicting parameters now have model-specific names
- Users' localStorage data will be automatically migrated on first load

Tested:
- All models can be switched without parameter conflicts
- Presets save and load correctly
- History records restore correctly
- Price estimation works correctly"

# 推送到远程
git push origin refactor/parameter-conflicts
```

---

## 🔄 回滚方案

如果重构出现严重问题，可以快速回滚：

```bash
# 方案 1: 回到备份分支
git checkout backup-before-refactor

# 方案 2: 重置到重构前的提交
git reset --hard HEAD~1

# 方案 3: 创建反向提交
git revert HEAD
```

---

## 📝 注意事项

### 1. 用户数据
- ✅ 脚本已生成数据迁移代码
- ✅ 迁移会自动运行一次
- ⚠️ 建议在生产环境前先在测试环境验证

### 2. 性能影响
- ✅ 参数重命名不影响性能
- ✅ 数据迁移只运行一次
- ✅ 迁移后的数据结构与之前相同

### 3. 兼容性
- ⚠️ 这是一个破坏性更改
- ⚠️ 旧版本的预设和历史记录需要迁移
- ✅ 迁移脚本会自动处理

### 4. 团队协作
- 📢 通知团队成员即将进行重构
- 📢 确保所有人都提交了代码
- 📢 重构完成后通知团队拉取最新代码

---

## 🆘 常见问题

### Q1: 脚本运行失败怎么办？
**A**:
1. 检查 Python 版本（需要 3.7+）
2. 查看错误信息
3. 手动执行失败的步骤

### Q2: 编译错误怎么办？
**A**:
1. 查看具体错误信息
2. 搜索错误中提到的参数名
3. 手动修正为新的参数名

### Q3: 参数还是混乱怎么办？
**A**:
1. 检查是否所有文件都已修改
2. 检查是否有遗漏的参数引用
3. 清除浏览器缓存和 localStorage
4. 重新运行迁移脚本

### Q4: 历史记录无法恢复怎么办？
**A**:
1. 检查迁移脚本是否正确执行
2. 查看浏览器控制台的迁移日志
3. 手动检查 localStorage 中的数据
4. 如果数据损坏，从备份恢复

### Q5: 可以只重构部分模型吗？
**A**:
可以，但不推荐。部分重构会导致：
- 代码不一致
- 未来维护困难
- 可能遗漏某些冲突

建议一次性完成所有重构。

---

## 📞 需要帮助？

如果遇到问题：
1. 查看生成的报告文件
2. 检查浏览器控制台
3. 查看 Git 提交历史
4. 回滚到备份分支

---

## ✅ 完成检查清单

重构完成后，确认以下所有项：

- [ ] 所有脚本都已成功运行
- [ ] 没有编译错误
- [ ] 所有测试项都已通过
- [ ] 数据迁移正常工作
- [ ] 代码已提交到 Git
- [ ] 团队成员已通知
- [ ] 文档已更新（如果需要）

---

**祝重构顺利！** 🎉
