# 获取任务详情 - KIE API

## 概述
使用此端点查询通过Market模型API创建的任何任务的状态和结果。这是一个统一的查询接口，适用于Market类别下的所有模型。

## API端点
```
GET https://api.kie.ai/api/v1/jobs/recordInfo
```

## 查询参数
| 参数名 | 类型 | 是否必需 | 描述 |
| :--- | :--- | :--- | :--- |
| `taskId` | string | 是 | 创建任务时返回的唯一任务标识符。**示例**: `task_12345678` |

## 请求示例
```bash
curl -X GET "https://api.kie.ai/api/v1/jobs/recordInfo?taskId=task_12345678" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

## 响应格式
### 响应字段
| 字段路径 | 类型 | 描述 |
| :--- | :--- | :--- |
| `code` | integer | 响应状态码。`200`表示成功。 |
| `message` | string | 响应消息。成功查询通常为`"success"`。 |
| `data` | object | 包含所有任务信息的任务数据对象。 |
| `data.taskId` | string | 此任务的唯一标识符。 |
| `data.model` | string | 用于此任务的模型（例如`grok-imagine/text-to-image`、`seedream-4.0`、`kling-1.0`）。 |
| `data.state` | string | 任务的当前状态。详见下方[任务状态](#任务状态-1)。**可能的值**: `waiting`、`queuing`、`generating`、`success`、`fail` |
| `data.param` | string | 包含创建任务时使用的原始请求参数的JSON字符串。 |
| `data.resultJson` | string | 包含生成内容URL的JSON字符串。仅在`state`为`success`时存在。**示例**: `{"resultUrls":["https://example.com/image.jpg"]}` |
| `data.failCode` | string | 任务失败时的错误代码。成功时为空字符串。 |
| `data.failMsg` | string | 任务失败时的错误消息。成功时为空字符串。 |
| `data.completeTime` | integer | 任务完成时的Unix时间戳（毫秒）。 |
| `data.createTime` | integer | 任务创建时的Unix时间戳（毫秒）。 |
| `data.updateTime` | integer | 任务最后更新时的Unix时间戳（毫秒）。 |

## 任务状态
| 状态 | 描述 | 操作 |
| :--- | :--- | :--- |
| `waiting` | 任务已排队等待处理 | 继续轮询 |
| `queuing` | 任务在处理队列中 | 继续轮询 |
| `generating` | 任务正在处理中 | 继续轮询 |
| `success` | 任务成功完成 | 解析`resultJson`获取结果 |
| `fail` | 任务失败 | 查看`failCode`和`failMsg`了解详情 |

## 轮询最佳实践
### 推荐的轮询间隔
*   **初始轮询（前30秒）**: 每2-3秒
*   **30秒后**: 每5-10秒
*   **2分钟后**: 每15-30秒
*   **最大轮询时长**: 10-15分钟后停止并调查

使用指数退避来减少服务器负载和API成本。

### 使用回调而非轮询
对于生产应用，我们强烈建议在创建任务时使用`callBackUrl`参数：
*   **无需轮询**: 您的服务器自动接收通知
*   **降低API成本**: 消除持续的轮询请求
*   **更好的性能**: 任务完成时立即通知
*   **降低延迟**: 完成和通知之间无延迟

查看各个模型文档了解回调实现详情。

### 处理已完成的任务
当`state`为`success`时：
1.  将`resultJson`字符串解析为JSON
2.  提取`resultUrls`数组
3.  立即下载生成的内容
4.  将内容存储在您自己的存储中

**重要**: 生成的内容URL通常在24小时后过期。

## 错误处理
### 常见错误代码
| 代码 | 描述 | 解决方案 |
| :--- | :--- | :--- |
| `401` | 未授权 - API密钥无效或缺失 | 检查您的API密钥 |
| `404` | 未找到任务 | 验证taskId是否正确 |
| `422` | 原始请求中的验证错误 | 查看`failMsg`了解详情 |
| `500` | 内部服务器错误 | 几分钟后重试 |
| `501` | 生成失败 | 查看`failMsg`了解具体错误详情 |

## 示例: 完整的轮询流程
```javascript
async function pollTaskStatus(taskId, maxAttempts = 60, interval = 5000) {
  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    const response = await fetch(
      `https://api.kie.ai/api/v1/jobs/recordInfo?taskId=${taskId}`,
      {
        headers: { 'Authorization': 'Bearer YOUR_API_KEY' }
      }
    );
  
    const result = await response.json();
    const { state, resultJson, failMsg } = result.data;
  
    console.log(`尝试 ${attempt + 1}: 状态 = ${state}`);
  
    if (state === 'success') {
      const results = JSON.parse(resultJson);
      console.log('✅ 任务完成!');
      console.log('结果:', results.resultUrls);
      return results;
    }
  
    if (state === 'fail') {
      console.error('❌ 任务失败:', failMsg);
      throw new Error(failMsg);
    }
  
    // 仍在处理中，等待下次轮询
    await new Promise(resolve => setTimeout(resolve, interval));
  }

  throw new Error('任务在最大尝试次数后超时');
}

// 使用方法
try {
  const results = await pollTaskStatus('task_12345678');
  console.log('生成的内容URL:', results.resultUrls);
} catch (error) {
  console.error('错误:', error.message);
}
```

## 速率限制
*   **最大查询速率**: 每个API密钥每秒10次请求
*   **推荐间隔**: 轮询之间间隔2-5秒

过度轮询可能导致速率限制。生产应用请使用回调。

## 认证
所有 API 都需要通过 Bearer Token 进行身份验证。
**请求头**:
```
Authorization: Bearer YOUR_API_KEY
```
**获取 API Key**:
1.  访问 [API Key 管理页面](https://kie.ai/api-key) 获取您的 API Key

**注意**:
*   请妥善保管您的 API Key，不要与他人共享
*   如果您怀疑 API Key 已泄露，请立即在管理页面重置