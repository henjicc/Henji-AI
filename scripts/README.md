# 发布脚本使用指南

## 快速开始

### 交互式发布（推荐）

```bash
npm run release
```

这是最简单的方式，脚本会引导你完成整个发布流程。

### 直接指定版本

```bash
npm run release 0.1.2
```

跳过交互式提示，直接发布指定版本。

## 功能特性

### 1. 完整构建测试 ✅

发布前会自动运行 **完整的 Tauri 构建** (`npm run tauri:build:ci`)，这会：
- 编译 TypeScript 代码
- 构建 Vite 前端
- 编译 Rust 后端
- 打包生成安装程序（MSI/NSIS）

**优势：**
- 确保发布的代码可以成功构建
- 提前发现打包时才会出现的问题
- 构建产物可以直接用于发布，无需再次构建

如果构建失败，脚本会立即终止并提示你修复错误。

### 2. 智能版本号建议 🎯

- 自动读取当前版本（如 `0.1.1`）
- 建议下一个版本号（如 `0.1.2`）
- 直接回车使用建议版本
- 或手动输入自定义版本号

### 3. 多行更新日志输入 📝

支持输入多行更新日志：

```
请输入更新日志 (可选，多行输入):
提示: 输入多行内容，输入 "END" 或 "end" 单独一行表示结束
提示: 直接输入 "END" 跳过此步骤

- 修复了自动切换导致无法手动选择比例的问题
- 新增右键菜单粘贴文件管理器复制的图片功能
- 优化了图片上传性能
END
```

更新日志会被保存到：
- `CHANGELOG.md` 文件
- Git 提交信息
- Git 标签注释

### 4. 自动更新所有版本号 🔄

脚本会自动更新以下文件中的版本号：
- `package.json`
- `package-lock.json`
- `src-tauri/tauri.conf.json`
- `src-tauri/Cargo.toml`
- `src-tauri/Cargo.lock`
- `src/services/updateChecker.ts`
- `src-tauri/nsis/installer.nsh`

### 5. 自动 Git 操作 🚀

- 提交所有版本更改
- 创建 Git 标签（带更新日志注释）
- 推送到远程仓库

## 完整流程示例

```bash
$ npm run release

🚀 Henji-AI 版本发布工具
═══════════════════════════════════════

ℹ 检查 Git 工作区状态...
✓ Git 工作区干净

ℹ 步骤 0/7: 运行完整构建测试...

正在运行 Tauri 完整构建（这可能需要几分钟）...
提示: 构建过程中会显示详细输出

[构建输出...]

✓ Tauri 构建成功！

✓ 构建测试通过，构建产物已生成！
构建产物位置: src-tauri/target/release/bundle/


当前版本: 0.1.1
建议版本: 0.1.2

请输入新版本号 (直接回车使用 0.1.2): [直接回车]

请输入更新日志 (可选，多行输入):
提示: 输入多行内容，输入 "END" 或 "end" 单独一行表示结束
提示: 直接输入 "END" 跳过此步骤

- 修复了版本号不一致的问题
- 添加了自动化发布脚本
END

═══════════════════════════════════════
发布信息确认
═══════════════════════════════════════
版本号: 0.1.2
更新日志:
  - 修复了版本号不一致的问题
  - 添加了自动化发布脚本
═══════════════════════════════════════

确认发布？(y/n): y

ℹ 开始发布版本 0.1.2...

ℹ 步骤 1/7: 更新版本号...
✓ 已更新 package.json
✓ 已更新 src-tauri/tauri.conf.json
✓ 已更新 src-tauri/Cargo.toml
✓ 已更新 src/services/updateChecker.ts
✓ 已更新 src-tauri/nsis/installer.nsh

ℹ 步骤 2/7: 保存更新日志...
✓ 更新日志已保存到 CHANGELOG.md

ℹ 步骤 3/7: 更新 Cargo.lock...
✓ Cargo.lock 已更新

ℹ 步骤 4/7: 更新 package-lock.json...
✓ package-lock.json 已更新

ℹ 步骤 5/7: 提交更改...
✓ 更改已提交

ℹ 步骤 6/7: 创建 Git 标签...
✓ 标签 v0.1.2 已创建

ℹ 步骤 7/7: 推送到远程仓库...
✓ 已推送到远程仓库

✓ 🎉 版本 0.1.2 发布成功！

ℹ 下一步：
  1. 在 GitHub 上查看自动创建的标签
  2. 构建产物已生成在 src-tauri/target/release/bundle/
  3. 在 GitHub 上创建 Release 并上传构建产物

更新日志已保存到 CHANGELOG.md 和 Git 标签中
```

## 常见问题

### Q: 如果构建检查失败怎么办？

A: 脚本会立即终止并显示错误信息。修复错误后重新运行 `npm run release`。

### Q: 可以跳过更新日志吗？

A: 可以。在提示输入更新日志时，直接输入 `END` 即可跳过。

### Q: 如何输入多行更新日志？

A: 直接输入多行内容，每行一个条目。输入完成后，单独一行输入 `END` 表示结束。

### Q: 版本号格式有什么要求？

A: 必须是 `x.y.z` 格式，例如 `0.1.2` 或 `1.0.0`。

### Q: 如果 Git 工作区有未提交的更改怎么办？

A: 脚本会提示你，并询问是否继续。建议先提交或暂存现有更改。

### Q: 可以撤销发布吗？

A: 如果还没有推送到远程，可以使用以下命令撤销：
```bash
git reset --hard HEAD~1  # 撤销提交
git tag -d v0.1.2        # 删除标签
```

如果已经推送，需要手动删除远程标签：
```bash
git push origin :refs/tags/v0.1.2
```

## 查看帮助

```bash
npm run release --help
```

## 技术细节

脚本执行的完整步骤：

0. **构建检查**
   - TypeScript 编译（`tsc --noEmit`）
   - ESLint 检查（`npm run lint`）
   - Vite 构建（`npm run build`）
   - Cargo 检查（`cargo check`）

1. **版本号更新**
   - 更新 5 个文件中的版本号

2. **更新日志**
   - 保存到 `CHANGELOG.md`（如果提供）

3. **依赖更新**
   - 更新 `Cargo.lock`
   - 更新 `package-lock.json`

4. **Git 提交**
   - 添加所有更改的文件
   - 创建提交（包含更新日志）

5. **Git 标签**
   - 创建带注释的标签（如果有更新日志）
   - 或创建轻量级标签

6. **推送**
   - 推送提交到 `main` 分支
   - 推送标签到远程

## 注意事项

- 确保你有推送到远程仓库的权限
- 发布前建议先在本地测试构建
- 版本号一旦发布就不应该修改
- 更新日志会永久保存在 Git 历史中
